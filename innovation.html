<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Innovation Hall of Fame | Arkastone</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.2/dist/browser-image-compression.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background: #E2E8F0; margin: 0; padding: 0; }
        
        @keyframes slideToLeft { 
            from { opacity: 0; transform: translateX(50px); } 
            to { opacity: 1; transform: translateX(0); } 
        }

        .innovation-card { 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            flex: 0 0 400px; 
            cursor: grab; 
            height: 200px; 
            user-select: none; 
            animation: slideToLeft 0.8s cubic-bezier(0.25, 1, 0.5, 1) both;
        }

        .innovation-card:active { cursor: grabbing; transform: scale(0.98); }
        .innovation-card:hover { transform: translateY(-5px); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .active-year { background-color: #2563eb !important; color: white !important; border-color: #2563eb !important; }
        
        .innovation-group { scroll-margin-top: 100px; }
        
        .horizontal-scroll, .draggable-scroll {
            display: flex;
            overflow-x: auto;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            gap: 1.5rem;
            padding-bottom: 1.5rem;
            width: 100%;
            cursor: grab;
        }

        .draggable-scroll { padding-bottom: 0; gap: 0.5rem; }

        .horizontal-scroll:active, .draggable-scroll:active { cursor: grabbing; scroll-behavior: auto; }

        #innovationModal, #dataModal, #deleteConfirmModal { transition: opacity 0.3s ease-in-out; }
        .modal-content { transition: transform 0.3s ease-out; }
    </style>
</head>
<body class="w-full">

    <div class="sticky top-0 z-50 bg-[#E2E8F0]/90 backdrop-blur-md border-b border-gray-200">
        <div class="pt-4 px-6 pb-4">
            <div class="flex flex-col lg:flex-row gap-4 justify-between items-center bg-white p-2 rounded-2xl border border-gray-100 shadow-sm">
                <div class="flex items-center gap-2 w-full lg:w-auto overflow-hidden">
                    <button onclick="filterYear('all')" id="btn-all" class="year-filter-btn px-6 py-2 rounded-xl text-xs font-bold transition-all shrink-0 active-year">Semua</button>
                    <div class="h-8 w-[1px] bg-gray-200 hidden md:block mx-1"></div>
                    
                    <!-- Panah Kiri -->
                    <button onclick="scrollYears('left')" class="p-2 hover:bg-gray-100 rounded-lg transition-colors shrink-0">
                        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    </button>

                    <div id="yearButtonsContainer" class="draggable-scroll no-scrollbar py-1"></div>

                    <!-- Panah Kanan -->
                    <button onclick="scrollYears('right')" class="p-2 hover:bg-gray-100 rounded-lg transition-colors shrink-0">
                        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                    </button>
                </div>
                <div class="flex items-center gap-3 w-full lg:w-auto">
                    <div class="relative w-full lg:w-72">
                        <input type="text" id="searchInput" onkeyup="searchInovation()" placeholder="Cari inovasi..." class="pl-10 pr-4 py-2 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm w-full transition-all">
                        <svg class="w-4 h-4 text-gray-400 absolute left-3.5 top-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    </div>
                    <!-- Tombol Data & Add dengan ID untuk kontrol akses -->
                    <button id="btnToggleData" onclick="toggleDataModal()" class="hidden flex items-center gap-2 bg-emerald-600 hover:bg-emerald-700 text-white px-5 py-2 rounded-xl text-sm font-semibold shadow-md transition-all active:scale-95 shrink-0">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg> Data
                    </button>
                    <button id="btnToggleAdd" onclick="toggleModal()" class="hidden flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-xl text-sm font-semibold shadow-md transition-all active:scale-95 shrink-0">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg> Add
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Innovation -->
    <div id="innovationModal" class="fixed inset-0 z-[60] hidden overflow-y-auto">
        <div class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm"></div>
        <div class="flex min-h-full items-center justify-center p-4">
            <div class="modal-content relative w-full max-w-4xl bg-white rounded-[2rem] shadow-2xl overflow-hidden transform scale-95 opacity-0 transition-all duration-300">
                <div class="flex justify-between items-center p-6 border-b border-gray-100 bg-gray-50/50">
                    <div>
                        <h3 id="modalTitle" class="text-xl font-bold text-gray-800">Formulir Inovasi Baru</h3>
                        <p class="text-xs text-gray-500 mt-1">Lengkapi data untuk menambahkan inovasi ke Hall of Fame.</p>
                    </div>
                    <button onclick="toggleModal()" class="p-2 bg-white rounded-full shadow-sm text-gray-400 hover:text-red-500 transition-all">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <form id="addInnovationForm">
                    <input type="hidden" id="editInnovationId">
                    <div class="flex flex-col md:flex-row">
                        <div class="flex-1 p-8 bg-white border-r border-gray-100">
                            <div class="flex items-center gap-2 mb-6 text-blue-600 h-5">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z"></path></svg>
                                <span class="text-xs font-bold uppercase tracking-wider">Informasi Pengaju</span>
                            </div>
                            <div class="space-y-4">
                                <div class="space-y-1">
                                    <label class="text-[13px] font-semibold text-gray-700 ml-1">Tanggal</label>
                                    <input type="date" id="inputTanggal" required class="w-full px-4 py-2 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none text-sm transition-all">
                                </div>
                                <div class="space-y-1">
                                    <label class="text-[13px] font-semibold text-gray-700 ml-1">Nama Lengkap</label>
                                    <select id="inputNama" required class="w-full px-4 py-2 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none text-sm transition-all">
                                        <option value="" disabled selected>Pilih Karyawan</option>
                                    </select>
                                </div>
                                <div class="space-y-1">
                                    <label class="text-[13px] font-semibold text-gray-700 ml-1">Jabatan</label>
                                    <input type="text" id="inputJabatan" placeholder="Terisi otomatis..." readonly required class="w-full px-4 py-2 bg-gray-100 border border-gray-200 rounded-xl outline-none text-sm cursor-not-allowed">
                                </div>
                                <div class="space-y-1">
                                    <label class="text-[13px] font-semibold text-gray-700 ml-1">Departemen</label>
                                    <input type="text" id="inputDepartemen" placeholder="Terisi otomatis..." readonly required class="w-full px-4 py-2 bg-gray-100 border border-gray-200 rounded-xl outline-none text-sm cursor-not-allowed">
                                </div>
                                <div class="space-y-1">
                                    <label class="text-[13px] font-semibold text-gray-700 ml-1">E-mail</label>
                                    <input type="email" id="inputEmail" placeholder="Terisi otomatis..." readonly class="w-full px-4 py-2 bg-gray-100 border border-gray-200 rounded-xl outline-none text-sm cursor-not-allowed">
                                </div>
                                <div class="space-y-1">
                                    <label class="text-[13px] font-semibold text-gray-700 ml-1">No. Telp</label>
                                    <input type="text" id="inputPhone" placeholder="Terisi otomatis..." readonly class="w-full px-4 py-2 bg-gray-100 border border-gray-200 rounded-xl outline-none text-sm cursor-not-allowed">
                                </div>
                            </div>
                        </div>

                        <div class="flex-1 p-8 bg-slate-50/30">
                            <div class="flex items-center gap-2 mb-6 text-purple-600 h-5">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M11 3a1 1 0 10-2 0v1a1 1 0 102 0V3zM18 10a1 1 0 10-2 0v1a1 1 0 102 0v-1z"></path></svg>
                                <span class="text-xs font-bold uppercase tracking-wider">Detail Inovasi</span>
                            </div>
                            <div class="space-y-5">
                                <div class="flex justify-center pb-2">
                                    <div id="avatarPreviewContainer" class="w-32 h-32 rounded-full bg-gray-200 border-4 border-white shadow-xl overflow-hidden shrink-0 flex items-center justify-center">
                                        <svg id="placeholderAvatar" class="w-16 h-16 text-gray-400" fill="currentColor" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                                        <img id="imgPreview" src="" class="w-full h-full object-cover hidden">
                                    </div>
                                    <input type="url" id="inputPhotoUrl" readonly class="hidden">
                                </div>
                                <div class="space-y-1.5">
                                    <label class="text-[13px] font-semibold text-gray-700 ml-1">Judul Inovasi</label>
                                    <input type="text" id="inputJudul" placeholder="Judul inovasi" required class="w-full px-4 py-2.5 bg-white border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 outline-none text-sm font-bold transition-all">
                                </div>
                                <div class="space-y-1.5">
                                    <label class="text-[13px] font-semibold text-gray-700 ml-1">Deskripsi Inovasi</label>
                                    <textarea id="inputDeskripsi" style="height: 110px;" placeholder="Jelaskan inovasi..." required class="w-full px-4 py-2.5 bg-white border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 outline-none text-sm resize-none transition-all"></textarea>
                                </div>
                                <div class="space-y-1.5">
                                    <label class="text-[13px] font-semibold text-gray-700 ml-1 flex items-center gap-2">
                                        <svg class="w-4 h-4 text-blue-600" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71z"/></svg> URL Google Drive
                                    </label>
                                    <input type="url" id="inputUrlDrive" placeholder="https://drive.google.com/..." required class="w-full px-4 py-2.5 bg-white border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none text-xs transition-all">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="p-6 bg-gray-50 border-t border-gray-100 flex gap-4 justify-end">
                        <button type="button" onclick="toggleModal()" class="px-8 py-2.5 text-sm font-bold text-gray-500 hover:text-gray-700 transition">Batal</button>
                        <button type="submit" id="submitBtn" class="px-10 py-2.5 bg-blue-600 text-white rounded-xl font-bold text-sm shadow-lg shadow-blue-200 hover:bg-blue-700 active:scale-95 transition-all">Simpan Inovasi</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Data Employee -->
    <div id="dataModal" class="fixed inset-0 z-[60] hidden overflow-y-auto">
        <div class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm"></div>
        <div class="flex min-h-full items-center justify-center p-4">
            <div class="modal-content relative w-full max-w-lg bg-white rounded-[2rem] shadow-2xl overflow-hidden transform scale-95 opacity-0 transition-all duration-300">
                <div class="flex justify-between items-center p-6 border-b border-gray-100 bg-emerald-50/50">
                    <div>
                        <h3 class="text-xl font-bold text-gray-800">Formulir Data Personel</h3>
                        <p class="text-xs text-gray-500 mt-1">Simpan profil tim ke tabel Employees.</p>
                    </div>
                    <button onclick="toggleDataModal()" class="p-2 bg-white rounded-full shadow-sm text-gray-400 hover:text-red-500 transition-all">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <form id="addEmployeeForm" class="p-8 space-y-4">
                    <div class="space-y-1.5">
                        <label class="text-[13px] font-semibold text-gray-700 ml-1">Nama Lengkap</label>
                        <input type="text" id="empNama" required class="w-full px-4 py-2.5 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none text-sm transition-all">
                    </div>
                    <div class="space-y-1.5">
                        <label class="text-[13px] font-semibold text-gray-700 ml-1">Jabatan</label>
                        <input type="text" id="empJabatan" required class="w-full px-4 py-2.5 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none text-sm transition-all">
                    </div>
                    <div class="space-y-1.5">
                        <label class="text-[13px] font-semibold text-gray-700 ml-1">Departemen</label>
                        <input type="text" id="empDept" required class="w-full px-4 py-2.5 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none text-sm transition-all">
                    </div>
                    <div class="space-y-1.5">
                        <label class="text-[13px] font-semibold text-gray-700 ml-1">Email</label>
                        <input type="email" id="empEmail" required class="w-full px-4 py-2.5 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none text-sm transition-all">
                    </div>
                    <div class="space-y-1.5">
                        <label class="text-[13px] font-semibold text-gray-700 ml-1">No. Telp</label>
                        <input type="tel" id="empPhone" placeholder="Contoh: 08123456789" required class="w-full px-4 py-2.5 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none text-sm transition-all">
                    </div>
                    <div class="space-y-1.5">
                        <label class="text-[13px] font-semibold text-gray-700 ml-1">Upload Photo</label>
                        <input type="file" id="empPhotoFile" accept="image/*" required class="w-full px-4 py-2 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none text-sm file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-emerald-50 file:text-emerald-700 hover:file:bg-emerald-100 transition-all">
                        <div id="compressionStatus" class="text-[10px] text-emerald-600 mt-1 hidden italic">Sedang mengompres gambar...</div>
                    </div>
                    <div class="pt-4 flex gap-4 justify-end">
                        <button type="button" onclick="toggleDataModal()" class="px-6 py-2.5 text-sm font-bold text-gray-500 hover:text-gray-700 transition">Batal</button>
                        <button type="submit" id="submitEmpBtn" class="px-8 py-2.5 bg-emerald-600 text-white rounded-xl font-bold text-sm shadow-lg shadow-emerald-200 hover:bg-emerald-700 active:scale-95 transition-all">Simpan Data</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Konfirmasi Hapus -->
    <div id="deleteConfirmModal" class="fixed inset-0 z-[70] hidden overflow-y-auto">
        <div class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm"></div>
        <div class="flex min-h-full items-center justify-center p-4">
            <div class="modal-content relative w-full max-w-sm bg-white rounded-[2rem] shadow-2xl p-8 transform scale-95 opacity-0 transition-all duration-300">
                <div class="text-center">
                    <div class="w-16 h-16 bg-red-100 text-red-600 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                    </div>
                    <h3 class="text-lg font-bold text-gray-800">Hapus Inovasi?</h3>
                    <p class="text-sm text-gray-500 mt-2">Tindakan ini tidak dapat dibatalkan. Apakah Anda yakin ingin menghapus data inovasi ini?</p>
                </div>
                <div class="flex gap-3 mt-8">
                    <button onclick="toggleDeleteModal()" class="flex-1 px-4 py-2.5 bg-gray-100 hover:bg-gray-200 text-gray-600 rounded-xl font-bold text-sm transition">Batal</button>
                    <button id="confirmDeleteBtn" class="flex-1 px-4 py-2.5 bg-red-500 hover:bg-red-600 text-white rounded-xl font-bold text-sm shadow-lg shadow-red-200 transition active:scale-95">Ya, Hapus</button>
                </div>
            </div>
        </div>
    </div>

    <div id="innovationContainer" class="px-6 pt-4 pb-20"></div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

        const supabaseUrl = 'https://dqfithvufqewtchicrgw.supabase.co'
        const supabaseKey = 'sb_publishable_wp6piNTxSLOXT-ezmfnhaQ_cFKP13k7'
        const supabase = createClient(supabaseUrl, supabaseKey)
        const IMGBB_API_KEY = 'f31bfbe875f04412eaa99630d5d4b8af';

        const container = document.getElementById('innovationContainer');
        const yearButtonsContainer = document.getElementById('yearButtonsContainer');
        const inputNamaSelect = document.getElementById('inputNama');
        let allInnovations = [];
        let masterEmployees = []; 
        let currentFilter = 'all';
        let isAdmin = false;
        let deleteId = null;

        // --- FUNGSI PROTEKSI AKSES ADMIN ---
        async function checkAdminAccess() {
            const sessionData = sessionStorage.getItem('sessionUser');
            if (!sessionData) return;
            const user = JSON.parse(sessionData);

            try {
                const { data, error } = await supabase
                    .from('users')
                    .select('authority')
                    .eq('username', user.username)
                    .single();

                if (data && data.authority.toLowerCase() === 'admin') {
                    isAdmin = true;
                    document.getElementById('btnToggleData').classList.remove('hidden');
                    document.getElementById('btnToggleAdd').classList.remove('hidden');
                    // Tampilkan semua elemen admin-only di kartu
                    document.querySelectorAll('.admin-only').forEach(el => el.classList.remove('hidden'));
                }
            } catch (err) {
                console.error('Gagal verifikasi authority:', err.message);
            }
        }

        function initDragToScroll() {
            document.addEventListener('mousedown', (e) => {
                const slider = e.target.closest('.horizontal-scroll') || e.target.closest('.draggable-scroll');
                if (!slider) return;
                let isDown = true;
                const startX = e.pageX - slider.offsetLeft;
                const scrollLeft = slider.scrollLeft;
                slider.classList.add('active');
                const onMouseMove = (e) => {
                    if (!isDown) return;
                    e.preventDefault();
                    const x = e.pageX - slider.offsetLeft;
                    const walk = (x - startX) * 2;
                    slider.scrollLeft = scrollLeft - walk;
                };
                const onMouseUp = () => {
                    isDown = false;
                    slider.classList.remove('active');
                    document.removeEventListener('mousemove', onMouseMove);
                    document.removeEventListener('mouseup', onMouseUp);
                };
                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            });
        }

        // Fungsi khusus untuk scroll tahun dengan panah
        window.scrollYears = function(direction) {
            const slider = document.getElementById('yearButtonsContainer');
            const scrollAmount = 200;
            if (direction === 'left') {
                slider.scrollBy({ left: -scrollAmount, behavior: 'smooth' });
            } else {
                slider.scrollBy({ left: scrollAmount, behavior: 'smooth' });
            }
        }

        let autoScrollInterval;
        function initInfiniteRoll() {
            if (autoScrollInterval) clearInterval(autoScrollInterval);

            const sliders = document.querySelectorAll('.horizontal-scroll');
            const scrollStates = new Map();

            sliders.forEach(slider => {
                scrollStates.set(slider, { direction: 1, isPaused: false });
                slider.addEventListener('mouseenter', () => scrollStates.get(slider).isPaused = true);
                slider.addEventListener('mouseleave', () => scrollStates.get(slider).isPaused = false);
                slider.addEventListener('mousedown', () => scrollStates.get(slider).isPaused = true);
                slider.addEventListener('touchstart', () => scrollStates.get(slider).isPaused = true);
            });

            autoScrollInterval = setInterval(() => {
                sliders.forEach(slider => {
                    const state = scrollStates.get(slider);
                    if (state.isPaused) return;

                    const maxScroll = slider.scrollWidth - slider.clientWidth;
                    if (maxScroll <= 0) return;

                    if (slider.scrollLeft >= maxScroll - 1) {
                        state.direction = -1;
                    } else if (slider.scrollLeft <= 0) {
                        state.direction = 1;
                    }

                    slider.scrollBy({
                        left: state.direction * 0.8,
                        behavior: 'auto'
                    });
                });
            }, 30);
        }

        window.toggleModal = function() {
            const modal = document.getElementById('innovationModal');
            const content = modal.querySelector('.modal-content');
            if (modal.classList.contains('hidden')) {
                // Reset form jika membuka modal Add
                if (!document.getElementById('editInnovationId').value) {
                    document.getElementById('addInnovationForm').reset();
                    document.getElementById('modalTitle').innerText = 'Formulir Inovasi Baru';
                    document.getElementById('imgPreview').classList.add('hidden');
                    document.getElementById('placeholderAvatar').classList.remove('hidden');
                }
                modal.classList.remove('hidden');
                setTimeout(() => { content.classList.remove('scale-95', 'opacity-0'); content.classList.add('scale-100', 'opacity-100'); }, 10);
                document.body.style.overflow = 'hidden';
                loadEmployeeList(); 
            } else {
                content.classList.remove('scale-100', 'opacity-100'); content.classList.add('scale-95', 'opacity-0');
                setTimeout(() => {
                    modal.classList.add('hidden');
                    document.getElementById('editInnovationId').value = '';
                }, 300);
                document.body.style.overflow = 'auto';
            }
        }

        window.toggleDataModal = function() {
            const modal = document.getElementById('dataModal');
            const content = modal.querySelector('.modal-content');
            if (modal.classList.contains('hidden')) {
                modal.classList.remove('hidden');
                setTimeout(() => { content.classList.remove('scale-95', 'opacity-0'); content.classList.add('scale-100', 'opacity-100'); }, 10);
                document.body.style.overflow = 'hidden';
            } else {
                content.classList.remove('scale-100', 'opacity-100'); content.classList.add('scale-95', 'opacity-0');
                setTimeout(() => modal.classList.add('hidden'), 300);
                document.body.style.overflow = 'auto';
            }
        }

        window.toggleDeleteModal = function(id = null) {
            deleteId = id;
            const modal = document.getElementById('deleteConfirmModal');
            const content = modal.querySelector('.modal-content');
            if (modal.classList.contains('hidden')) {
                modal.classList.remove('hidden');
                setTimeout(() => { content.classList.remove('scale-95', 'opacity-0'); content.classList.add('scale-100', 'opacity-100'); }, 10);
            } else {
                content.classList.remove('scale-100', 'opacity-100'); content.classList.add('scale-95', 'opacity-0');
                setTimeout(() => modal.classList.add('hidden'), 300);
            }
        }

        async function loadEmployeeList() {
            try {
                const { data, error } = await supabase.from('employees').select('*').order('nama', { ascending: true });
                if (error) throw error;
                masterEmployees = data;
                inputNamaSelect.innerHTML = '<option value="" disabled selected>Pilih Karyawan</option>';
                data.forEach(emp => {
                    const option = document.createElement('option');
                    option.value = emp.nama;
                    option.textContent = emp.nama;
                    inputNamaSelect.appendChild(option);
                });
            } catch (error) { console.error('Error loading employees:', error.message); }
        }

        async function loadInnovations() {
            try {
                const { data, error } = await supabase.from('innovations').select('*').order('tanggal', { ascending: false });
                if (error) throw error;
                allInnovations = data;
                renderContent(allInnovations);
                renderYearFilters(allInnovations);
                setTimeout(initInfiniteRoll, 1000); 
                if (isAdmin) {
                   document.querySelectorAll('.admin-only').forEach(el => el.classList.remove('hidden'));
                }
            } catch (error) { console.error('Fetch error:', error.message); }
        }

        function renderContent(data) {
            container.innerHTML = '';
            if (data.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-400 mt-20">Tidak ada inovasi ditemukan.</p>';
                return;
            }

            let groups = {};
            if (currentFilter === 'all') {
                data.forEach(item => {
                    const year = new Date(item.tanggal).getFullYear().toString();
                    if (!groups[year]) groups[year] = [];
                    groups[year].push(item);
                });
            } else {
                data.forEach(item => {
                    const d = new Date(item.tanggal);
                    const monthYear = d.toLocaleString('id-ID', { month: 'long', year: 'numeric' });
                    if (!groups[monthYear]) groups[monthYear] = [];
                    groups[monthYear].push(item);
                });
            }

            const sortedKeys = Object.keys(groups).sort((a, b) => {
                if (currentFilter === 'all') return b - a;
                return 0;
            });

            sortedKeys.forEach(title => {
                const groupDiv = document.createElement('div');
                groupDiv.className = 'innovation-group mb-4';
                const randomColor = '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6, '0');
                
                groupDiv.innerHTML = `
                    <div class="flex items-center gap-4 mb-6 w-full">
                        <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-3 whitespace-nowrap">
                            <span class="w-2 h-8 bg-blue-600 rounded-full"></span>
                            ${title}
                        </h2>
                        <div class="h-[2px] flex-grow rounded-full opacity-30" style="background-color: ${randomColor}"></div>
                        <span class="px-3 py-1 bg-gray-100 text-gray-500 rounded-full text-[10px] font-bold uppercase tracking-widest border border-gray-200">
                            ${groups[title].length} Inovasi
                        </span>
                    </div>
                    <div class="horizontal-scroll no-scrollbar">
                        ${groups[title].map((item, idx) => `
                            <div class="innovation-card border border-gray-100 shadow-sm bg-white overflow-hidden flex rounded-[2rem] relative shrink-0" 
                                 style="animation-delay: ${idx * 0.2}s">
                                <div class="w-1/3 h-full bg-gray-200 relative overflow-hidden shrink-0">
                                    ${item.photo_url ? 
                                        `<img src="${item.photo_url}" class="w-full h-full object-cover pointer-events-none">` : 
                                        `<div class="w-full h-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold text-3xl pointer-events-none">${item.nama.charAt(0)}</div>`
                                    }
                                    <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 via-black/40 to-transparent p-4 pt-10 pointer-events-none">
                                        <p class="text-[11px] font-extrabold text-white uppercase tracking-tight leading-tight">${item.nama}</p>
                                        <p class="text-[9px] text-gray-200 font-medium">${item.jabatan}</p>
                                    </div>
                                </div>
                                <div class="w-2/3 h-full relative p-6 flex flex-col bg-white pointer-events-none">
                                    <div class="relative z-20">
                                        <div class="flex justify-between items-start mb-2">
                                            <span class="px-2 py-0.5 bg-blue-50 text-blue-600 text-[8px] font-bold uppercase rounded border border-blue-100">${item.departemen}</span>
                                            <span class="text-gray-400 text-[9px] font-medium">${new Date(item.tanggal).toLocaleDateString('id-ID')}</span>
                                        </div>
                                        <h3 class="text-base font-bold text-gray-800 mb-2 line-clamp-2 leading-tight">${item.judul}</h3>
                                        <p class="text-gray-500 text-[11px] line-clamp-4 leading-relaxed">${item.deskripsi}</p>
                                    </div>
                                    <div class="absolute bottom-4 right-4 z-30 flex items-center gap-2 pointer-events-auto">
                                        <!-- Tombol Edit (Pena Hijau Lembut) -->
                                        <button onclick="editInnovation('${item.id}')" 
                                           class="admin-only hidden flex items-center justify-center w-7 h-7 bg-emerald-100 hover:bg-emerald-200 text-emerald-600 rounded-full transition-all shadow-sm hover:scale-110 active:scale-95"
                                           title="Edit Inovasi">
                                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
                                            </svg>
                                        </button>
                                        <!-- Tombol Hapus (Bin Merah Lembut) -->
                                        <button onclick="toggleDeleteModal('${item.id}')" 
                                           class="admin-only hidden flex items-center justify-center w-7 h-7 bg-red-100 hover:bg-red-200 text-red-600 rounded-full transition-all shadow-sm hover:scale-110 active:scale-95"
                                           title="Hapus Inovasi">
                                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-4v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                            </svg>
                                        </button>
                                        <!-- Tombol Open Drive -->
                                        <a href="${item.url_drive}" target="_blank" 
                                           class="flex items-center justify-center w-7 h-7 bg-blue-600 hover:bg-blue-700 text-white rounded-full transition-all shadow-lg hover:scale-110 active:scale-95"
                                           title="Detail Inovasi">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                                            </svg>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                container.appendChild(groupDiv);
            });
            
            if (isAdmin) {
                document.querySelectorAll('.admin-only').forEach(el => el.classList.remove('hidden'));
            }
        }

        window.editInnovation = async function(id) {
            const item = allInnovations.find(i => i.id == id);
            if (!item) return;

            document.getElementById('editInnovationId').value = item.id;
            document.getElementById('modalTitle').innerText = 'Edit Inovasi';
            
            document.getElementById('inputTanggal').value = item.tanggal;
            document.getElementById('inputNama').value = item.nama;
            document.getElementById('inputJabatan').value = item.jabatan;
            document.getElementById('inputDepartemen').value = item.departemen;
            document.getElementById('inputEmail').value = item.email || '';
            document.getElementById('inputPhone').value = item.phone || '';
            document.getElementById('inputPhotoUrl').value = item.photo_url || '';
            document.getElementById('inputJudul').value = item.judul;
            document.getElementById('inputDeskripsi').value = item.deskripsi;
            document.getElementById('inputUrlDrive').value = item.url_drive;

            const imgPreview = document.getElementById('imgPreview');
            const placeholder = document.getElementById('placeholderAvatar');
            if (item.photo_url) {
                imgPreview.src = item.photo_url;
                imgPreview.classList.remove('hidden');
                placeholder.classList.add('hidden');
            } else {
                imgPreview.classList.add('hidden');
                placeholder.classList.remove('hidden');
            }

            toggleModal();
        }

        document.getElementById('confirmDeleteBtn').addEventListener('click', async () => {
            if (!deleteId) return;
            const btn = document.getElementById('confirmDeleteBtn');
            btn.disabled = true; btn.innerText = 'Menghapus...';
            
            const { error } = await supabase.from('innovations').delete().eq('id', deleteId);
            if (error) { alert('Gagal hapus: ' + error.message); }
            else {
                toggleDeleteModal();
                loadInnovations();
            }
            btn.disabled = false; btn.innerText = 'Ya, Hapus';
        });

        window.filterYear = function(year) {
            currentFilter = year;
            document.querySelectorAll('.year-filter-btn, .year-btn').forEach(b => b.classList.remove('active-year'));
            if (year === 'all') {
                document.getElementById('btn-all').classList.add('active-year');
                renderContent(allInnovations);
            } else {
                if(event) event.target.classList.add('active-year');
                const filtered = allInnovations.filter(i => new Date(i.tanggal).getFullYear().toString() === year.toString());
                renderContent(filtered);
            }
            setTimeout(initInfiniteRoll, 500);
        }

        window.searchInovation = function() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allInnovations.filter(i => 
                i.judul.toLowerCase().includes(query) || 
                i.nama.toLowerCase().includes(query) || 
                i.departemen.toLowerCase().includes(query)
            );
            renderContent(filtered);
            setTimeout(initInfiniteRoll, 500);
        }

        function renderYearFilters(data) {
            const years = [...new Set(data.map(item => new Date(item.tanggal).getFullYear()))].sort((a, b) => b - a);
            yearButtonsContainer.innerHTML = years.map(year => 
                `<button onclick="filterYear('${year}')" class="year-btn border border-gray-200 text-gray-500 px-5 py-2 rounded-xl text-xs font-semibold hover:border-blue-400 transition shrink-0">${year}</button>`
            ).join('');
        }

        inputNamaSelect.addEventListener('change', (e) => {
            const selectedName = e.target.value;
            const emp = masterEmployees.find(item => item.nama === selectedName);
            const imgPreview = document.getElementById('imgPreview');
            const placeholder = document.getElementById('placeholderAvatar');
            if (emp) {
                document.getElementById('inputJabatan').value = emp.jabatan || '';
                document.getElementById('inputDepartemen').value = emp.departemen || '';
                document.getElementById('inputEmail').value = emp.email || '';
                document.getElementById('inputPhone').value = emp.phone || ''; 
                document.getElementById('inputPhotoUrl').value = emp.photo_url || '';
                if (emp.photo_url) {
                    imgPreview.src = emp.photo_url;
                    imgPreview.classList.remove('hidden');
                    placeholder.classList.add('hidden');
                } else {
                    imgPreview.classList.add('hidden');
                    placeholder.classList.remove('hidden');
                }
            }
        });

        document.getElementById('addInnovationForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submitBtn'); btn.disabled = true; btn.innerText = 'Menyimpan...';
            const editId = document.getElementById('editInnovationId').value;
            
            const payload = {
                tanggal: document.getElementById('inputTanggal').value,
                nama: document.getElementById('inputNama').value,
                jabatan: document.getElementById('inputJabatan').value,
                departemen: document.getElementById('inputDepartemen').value,
                email: document.getElementById('inputEmail').value,
                photo_url: document.getElementById('inputPhotoUrl').value,
                judul: document.getElementById('inputJudul').value,
                deskripsi: document.getElementById('inputDeskripsi').value,
                url_drive: document.getElementById('inputUrlDrive').value
            };

            let error;
            if (editId) {
                const res = await supabase.from('innovations').update(payload).eq('id', editId);
                error = res.error;
            } else {
                const res = await supabase.from('innovations').insert([payload]);
                error = res.error;
            }

            if (error) { alert('Gagal simpan: ' + error.message); } 
            else { 
                toggleModal(); 
                document.getElementById('addInnovationForm').reset(); 
                loadInnovations(); 
            }
            btn.disabled = false; btn.innerText = 'Simpan Inovasi';
        });

        async function handleImageUpload(file) {
            const options = { maxSizeMB: 0.7, maxWidthOrHeight: 1200, useWebWorker: true };
            try {
                document.getElementById('compressionStatus').classList.remove('hidden');
                const compressedFile = await imageCompression(file, options);
                const formData = new FormData();
                formData.append('image', compressedFile);
                const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: 'POST', body: formData });
                const result = await response.json();
                document.getElementById('compressionStatus').classList.add('hidden');
                if (result.success) {
                    let finalUrl = result.data.url;
                    if (finalUrl.includes('i.ibb.co') && !finalUrl.includes('i.ibb.co.com')) { finalUrl = finalUrl.replace('i.ibb.co', 'i.ibb.co.com'); }
                    return finalUrl; 
                } else { throw new Error('Upload ImgBB Gagal'); }
            } catch (error) {
                document.getElementById('compressionStatus').classList.add('hidden');
                alert('Gagal memproses gambar: ' + error.message);
                return null;
            }
        }

        document.getElementById('addEmployeeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submitEmpBtn');
            const photoFile = document.getElementById('empPhotoFile').files[0];
            if (!photoFile) return alert('Pilih foto terlebih dahulu');
            btn.disabled = true; btn.innerText = 'Memproses Gambar...';
            const photoUrl = await handleImageUpload(photoFile);
            if (photoUrl) {
                btn.innerText = 'Menyimpan...';
                const payload = {
                    nama: document.getElementById('empNama').value,
                    jabatan: document.getElementById('empJabatan').value,
                    departemen: document.getElementById('empDept').value,
                    email: document.getElementById('empEmail').value,
                    phone: document.getElementById('empPhone').value,
                    photo_url: photoUrl
                };
                const { error } = await supabase.from('employees').insert([payload]);
                if (error) { alert('Gagal simpan database: ' + error.message); } 
                else {
                    alert('Data Employee Berhasil Disimpan!');
                    toggleDataModal();
                    document.getElementById('addEmployeeForm').reset();
                    loadEmployeeList();
                }
            }
            btn.disabled = false; btn.innerText = 'Simpan Data';
        });

        // Jalankan pengecekan akses Admin & Load Data
        checkAdminAccess();
        loadInnovations();
        loadEmployeeList();
        initDragToScroll();
    </script>
</body>
</html>