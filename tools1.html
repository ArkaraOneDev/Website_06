<!DOCTYPE html>
<html lang="id" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tools Finder | Arkastone</title>
    
    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* --- Base Layout & Typography --- */
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #E2E8F0; 
            height: 100vh; 
            overflow: hidden; 
            display: flex;
            flex-direction: column;
        }
        
        html { font-size: 14px; }
        @media (min-width: 768px) { html { font-size: 16px; } }

        /* --- Animations --- */
        .bubble-item {
            animation: slideIn 0.3s ease-out forwards;
            opacity: 0;
        }
        @keyframes slideIn {
            from { transform: translateY(5px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .animate-column {
            opacity: 0;
            animation: columnFadeIn 0.5s ease-out forwards;
        }
        @keyframes columnFadeIn {
            from { opacity: 0; transform: scale(0.98); }
            to { opacity: 1; transform: scale(1); }
        }

        .delay-1 { animation-delay: 0.1s; }
        .delay-2 { animation-delay: 0.2s; }
        .delay-3 { animation-delay: 0.3s; }

        /* --- Scrollbar --- */
        .finder-col-content::-webkit-scrollbar { width: 4px; }
        .finder-col-content::-webkit-scrollbar-track { background: transparent; }
        .finder-col-content::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
        
        /* --- Item Styling --- */
        .column-entry {
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            padding: 10px 14px;
            margin: 4px 8px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.85rem;
            background: white;
            border: 1px solid #f1f5f9;
            box-shadow: 0 1px 2px rgba(0,0,0,0.03);
            white-space: nowrap;
        }
        .column-entry:hover:not(.selected-item) { 
            border-color: #bfdbfe;
            background-color: #f8fafc;
            transform: translateY(-1px);
        }

        /* --- Selected State --- */
        .selected-item { 
            background-color: #eff6ff !important; 
            color: #2563eb !important;
            border-color: #3b82f6 !important;
            box-shadow: 0 1px 2px rgba(37, 99, 235, 0.1);
        }
        .selected-item svg { color: inherit !important; }
        .selected-item span, .selected-item div { color: inherit !important; }

        /* --- UI Components --- */
        .menu-btn { opacity: 0; transition: opacity 0.2s; }
        .column-entry:hover .menu-btn { opacity: 1; }
        .selected-item .menu-btn { opacity: 1; color: #2563eb; }

        .col-header {
            padding: 12px 16px;
            font-size: 0.65rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            color: #64748b;
            background-color: #f1f5f9;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .col-footer {
            padding: 12px;
            border-top: 1px solid #f1f5f9;
            background-color: #ffffff;
            display: flex;
            justify-content: center;
        }

        .btn-add {
            background-color: #2563eb;
            color: white;
            font-size: 0.7rem;
            font-weight: 700;
            padding: 6px 16px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(37, 99, 235, 0.2);
        }
        .btn-add:hover:not(:disabled) { background-color: #1d4ed8; transform: translateY(-1px); }
        .btn-add:active { transform: scale(0.95); }
        .btn-add:disabled { background-color: #e2e8f0; color: #94a3b8; cursor: not-allowed; box-shadow: none; }

        /* --- Context Menu --- */
        #contextMenu {
            display: none;
            position: fixed;
            z-index: 1000;
            min-width: 150px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            padding: 4px;
        }
        .menu-item {
            padding: 8px 12px;
            font-size: 0.75rem;
            color: #475569;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            border-radius: 6px;
        }
        .menu-item:hover { background-color: #f1f5f9; color: #1e293b; }
        .menu-item.delete { color: #ef4444; }
        .menu-item.delete:hover { background-color: #fef2f2; }

        .rename-input {
            background: white;
            color: black;
            border: 2px solid #3b82f6;
            border-radius: 6px;
            padding: 4px 8px;
            font-size: 0.75rem;
            width: 100%;
            outline: none;
        }

        /* --- Modals --- */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background-color: rgba(15, 23, 42, 0.4);
            backdrop-filter: blur(4px);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-card {
            background: white;
            width: 100%;
            max-width: 400px;
            border-radius: 20px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            overflow: hidden;
            transform: scale(0.95);
            opacity: 0;
            transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .modal-card.show { transform: scale(1); opacity: 1; }

        /* --- Breadcrumb --- */
        .breadcrumb-container {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 10px 18px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            font-size: 0.8rem;
            color: #64748b;
            box-shadow: 0 1px 3px rgba(0,0,0,0.02);
        }
        .breadcrumb-separator { margin: 0 10px; color: #cbd5e1; font-weight: 300; }

        /* --- Mobile Logic --- */
        @media (max-width: 767px) {
            .mobile-hidden { display: none !important; }
        }

        /* --- Spreadsheet Table Styles --- */
        .ss-table { width: 100%; border-collapse: collapse; font-size: 0.75rem; }
        .ss-table th { background: #f8fafc; color: #64748b; font-weight: 700; text-transform: uppercase; padding: 10px; border: 1px solid #e2e8f0; text-align: left; }
        .ss-table td { border: 1px solid #e2e8f0; padding: 0; }
        .ss-input { width: 100%; border: none; padding: 10px; outline: none; background: transparent; }
        .ss-input:focus { background: #f1f5f9; }
        .ss-no { width: 40px; text-align: center; color: #94a3b8; font-weight: 600; background: #f8fafc; }
        .btn-ss-del { color: #ef4444; padding: 8px; display: flex; align-items: center; justify-content: center; width: 40px; }
        .btn-ss-del:hover { background: #fef2f2; }
    </style>
</head>
<body class="p-3 md:p-5" onclick="closeMenu()">

    <!-- Context Menu -->
    <div id="contextMenu">
        <div class="menu-item" onclick="handleAction('rename')">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
            Rename
        </div>
        <div id="menuDownload" class="menu-item hidden" onclick="handleAction('download')">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
            Buka Link
        </div>
        <div class="menu-item delete" onclick="handleAction('delete')">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
            Delete
        </div>
    </div>

    <!-- Modals -->
    <!-- Delete Confirmation -->
    <div id="deleteModalOverlay" class="modal-overlay" onclick="closeDeleteModal()">
        <div class="modal-card" id="deleteModalCard" onclick="event.stopPropagation()">
            <div class="p-6">
                <h3 class="text-lg font-bold text-gray-900 mb-2">Hapus Item?</h3>
                <p class="text-sm text-gray-500">Aksi ini akan menghapus data dari sistem secara permanen.</p>
            </div>
            <div class="bg-gray-50 px-6 py-4 flex flex-row-reverse gap-3">
                <button id="btnConfirmDelete" onclick="executeDeletion()" class="bg-red-600 text-white text-sm font-semibold px-5 py-2.5 rounded-lg hover:bg-red-700 transition-colors">Hapus</button>
                <button onclick="closeDeleteModal()" class="bg-white border border-gray-300 text-gray-700 text-sm font-semibold px-5 py-2.5 rounded-lg">Batal</button>
            </div>
        </div>
    </div>

    <!-- Folder Manage Modal (Column 1) -->
    <div id="folderModalOverlay" class="modal-overlay" onclick="closeFolderModal()">
        <div class="modal-card !max-w-2xl" id="folderModalCard" onclick="event.stopPropagation()">
            <div class="p-6">
                <div class="flex justify-between items-center mb-5">
                    <h3 class="text-lg font-bold text-gray-900 tracking-tight">Manage Folders</h3>
                </div>

                <div class="max-h-[50vh] overflow-y-auto rounded-lg border border-gray-200 shadow-inner bg-gray-50/30">
                    <table class="ss-table">
                        <thead>
                            <tr>
                                <th class="w-10 text-center">No</th>
                                <th>Nama Folder</th>
                                <th class="w-10"></th>
                            </tr>
                        </thead>
                        <tbody id="folderBody"></tbody>
                    </table>
                </div>

                <div class="flex justify-end mt-4">
                    <button onclick="addFolderRow()" class="text-blue-600 text-[10px] font-bold uppercase border-2 border-blue-600 px-4 py-1.5 rounded-full hover:bg-blue-600 hover:text-white transition-all shadow-sm active:scale-95">
                        + Tambah Baris
                    </button>
                </div>

                <div id="folderProgressContainer" class="hidden mt-4">
                    <div class="text-[10px] font-bold text-blue-600 mb-1 uppercase tracking-wider animate-pulse">Memproses data...</div>
                    <div class="w-full bg-gray-100 rounded-full h-1.5 overflow-hidden">
                        <div class="bg-blue-500 h-full w-full"></div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-6 py-4 flex flex-row-reverse gap-3">
                <button id="btnExecuteFolder" onclick="handleFolderBulkUpload()" class="bg-blue-600 text-white text-sm font-semibold px-8 py-2.5 rounded-xl shadow-lg shadow-blue-200 active:scale-95 transition-all">Simpan Perubahan</button>
                <button onclick="closeFolderModal()" class="bg-white border border-gray-300 text-gray-700 text-sm font-semibold px-5 py-2.5 rounded-xl hover:bg-gray-100 transition-colors">Batal</button>
            </div>
        </div>
    </div>

    <!-- Subfolder Manage Modal (Column 2) -->
    <div id="subfolderModalOverlay" class="modal-overlay" onclick="closeSubfolderModal()">
        <div class="modal-card !max-w-2xl" id="subfolderModalCard" onclick="event.stopPropagation()">
            <div class="p-6">
                <div class="flex justify-between items-center mb-5">
                    <h3 class="text-lg font-bold text-gray-900 tracking-tight">Manage Subfolders</h3>
                </div>

                <div class="max-h-[50vh] overflow-y-auto rounded-lg border border-gray-200 shadow-inner bg-gray-50/30">
                    <table class="ss-table">
                        <thead>
                            <tr>
                                <th class="w-10 text-center">No</th>
                                <th>Nama Subfolder</th>
                                <th class="w-10"></th>
                            </tr>
                        </thead>
                        <tbody id="subfolderBody"></tbody>
                    </table>
                </div>

                <div class="flex justify-end mt-4">
                    <button onclick="addSubfolderRow()" class="text-blue-600 text-[10px] font-bold uppercase border-2 border-blue-600 px-4 py-1.5 rounded-full hover:bg-blue-600 hover:text-white transition-all shadow-sm active:scale-95">
                        + Tambah Baris
                    </button>
                </div>

                <div id="subfolderProgressContainer" class="hidden mt-4">
                    <div class="text-[10px] font-bold text-blue-600 mb-1 uppercase tracking-wider animate-pulse">Memproses data...</div>
                    <div class="w-full bg-gray-100 rounded-full h-1.5 overflow-hidden">
                        <div class="bg-blue-500 h-full w-full"></div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-6 py-4 flex flex-row-reverse gap-3">
                <button id="btnExecuteSubfolder" onclick="handleSubfolderBulkUpload()" class="bg-blue-600 text-white text-sm font-semibold px-8 py-2.5 rounded-xl shadow-lg shadow-blue-200 active:scale-95 transition-all">Simpan Perubahan</button>
                <button onclick="closeSubfolderModal()" class="bg-white border border-gray-300 text-gray-700 text-sm font-semibold px-5 py-2.5 rounded-xl hover:bg-gray-100 transition-colors">Batal</button>
            </div>
        </div>
    </div>

    <!-- Link Manage Modal (Column 3) -->
    <div id="addModalOverlay" class="modal-overlay" onclick="closeAddModal()">
        <div class="modal-card !max-w-4xl" id="addModalCard" onclick="event.stopPropagation()">
            <div class="p-6">
                <div class="flex justify-between items-center mb-5">
                    <h3 class="text-lg font-bold text-gray-900 tracking-tight">Manage Links</h3>
                </div>

                <div class="max-h-[50vh] overflow-y-auto rounded-lg border border-gray-200 shadow-inner bg-gray-50/30">
                    <table class="ss-table">
                        <thead>
                            <tr>
                                <th class="w-10 text-center">No</th>
                                <th>Nama File</th>
                                <th>URL Google Drive / Link</th>
                                <th class="w-10"></th>
                            </tr>
                        </thead>
                        <tbody id="spreadsheetBody"></tbody>
                    </table>
                </div>

                <div class="flex justify-end mt-4">
                    <button onclick="addRow()" class="text-blue-600 text-[10px] font-bold uppercase border-2 border-blue-600 px-4 py-1.5 rounded-full hover:bg-blue-600 hover:text-white transition-all shadow-sm active:scale-95">
                        + Tambah Baris
                    </button>
                </div>

                <div id="uploadProgressContainer" class="hidden mt-4">
                    <div id="progressMessage" class="text-[10px] font-bold text-blue-600 mb-1 uppercase tracking-wider animate-pulse">Menyimpan data...</div>
                    <div class="w-full bg-gray-100 rounded-full h-1.5 overflow-hidden">
                        <div class="bg-blue-500 h-full w-full"></div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-6 py-4 flex flex-row-reverse gap-3">
                <button id="btnExecuteUpload" onclick="handleSpreadsheetUpload()" class="bg-blue-600 text-white text-sm font-semibold px-8 py-2.5 rounded-xl shadow-lg shadow-blue-200 active:scale-95 transition-all">Simpan Perubahan</button>
                <button onclick="closeAddModal()" class="bg-white border border-gray-300 text-gray-700 text-sm font-semibold px-5 py-2.5 rounded-xl hover:bg-gray-100 transition-colors">Batal</button>
            </div>
        </div>
    </div>

    <!-- Preview Modal -->
    <div id="previewModalOverlay" class="modal-overlay" onclick="closePreviewModal()">
        <div class="modal-card !max-w-5xl w-11/12 h-[85vh] flex flex-col" id="previewModalCard" onclick="event.stopPropagation()">
            <div class="p-4 border-b flex justify-between items-center bg-white">
                <h3 id="previewTitle" class="text-sm font-bold text-gray-900 truncate uppercase tracking-tight">Preview File</h3>
                <div class="flex items-center gap-2">
                    <button id="btnDownloadPreview" onclick="handleAction('download')" class="p-1 hover:bg-gray-100 rounded-full text-gray-500" title="Buka di Tab Baru">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                    </button>
                    <button onclick="closePreviewModal()" class="p-1 hover:bg-gray-100 rounded-full transition-colors">
                        <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
            </div>
            <div class="flex-1 bg-gray-100 relative overflow-hidden flex items-center justify-center">
                <iframe id="previewFrame" class="hidden w-full h-full border-none bg-white" src="" allow="autoplay"></iframe>
                <img id="previewImage" class="hidden max-w-full max-h-full object-contain" src="" alt="Preview">
                <div id="previewLoader" class="absolute inset-0 flex items-center justify-center bg-gray-50 z-[1]">
                    <div class="text-[10px] font-bold text-gray-400 animate-pulse tracking-widest uppercase">Memuat Preview...</div>
                </div>
            </div>
            <div class="p-3 border-t bg-gray-50 flex justify-end">
                <button onclick="closePreviewModal()" class="bg-white border border-gray-300 text-gray-700 text-xs font-semibold px-4 py-2 rounded-lg hover:bg-gray-50 transition-colors">Tutup</button>
            </div>
        </div>
    </div>

    <!-- Breadcrumb -->
    <div class="breadcrumb-container hidden md:flex">
        <div class="breadcrumb-item"><span>Development</span></div>
        <span class="breadcrumb-separator">/</span>
        <div class="breadcrumb-item"><span>Tools</span></div>
        <div id="dynamicPath" class="flex items-center"></div>
    </div>

    <!-- Finder Columns -->
    <div class="flex-1 flex flex-col md:flex-row gap-4 overflow-hidden">
        <!-- Column 1: Folders -->
        <div id="container-col1" class="flex-1 flex flex-col bg-white border border-gray-200 rounded-2xl overflow-hidden shadow-sm animate-column delay-1">
            <div class="col-header">Folders</div>
            <div id="col1" onclick="deselectItem(1)" class="finder-col-content overflow-y-auto py-3 flex-1"></div>
            <div class="col-footer" id="footerCol1">
                <button onclick="addItem(1)" class="btn-add">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                    Manage Folder
                </button>
            </div>
        </div>

        <!-- Column 2: Subfolders -->
        <div id="container-col2" class="flex-1 flex flex-col bg-white border border-gray-200 rounded-2xl overflow-hidden shadow-sm animate-column delay-2 mobile-hidden">
            <div class="col-header">
                <button onclick="navigateMobile(1)" class="md:hidden p-1 -ml-1 hover:bg-gray-200 rounded-lg">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                </button>
                Subfolders
            </div>
            <div id="col2" onclick="deselectItem(2)" class="finder-col-content overflow-y-auto py-3 flex-1 bg-gray-50/20"></div>
            <div class="col-footer" id="footerCol2">
                <button id="btnAddCol2" onclick="addItem(2)" class="btn-add" disabled>
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                    Manage Subfolders
                </button>
            </div>
        </div>

        <!-- Column 3: Links/Files -->
        <div id="container-col3" class="flex-1 flex flex-col bg-white border border-gray-200 rounded-2xl overflow-hidden shadow-sm animate-column delay-3 mobile-hidden">
            <div class="col-header">
                <button onclick="navigateMobile(2)" class="md:hidden p-1 -ml-1 hover:bg-gray-200 rounded-lg">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                </button>
                Links
            </div>
            <div id="col3" onclick="deselectItem(3)" class="finder-col-content overflow-y-auto py-3 flex-1"></div>
            <div class="col-footer" id="footerCol3">
                <button id="btnAddCol3" onclick="addItem(3)" class="btn-add" disabled>
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                    Manage Links
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. CONFIG & INIT ---
        const SUPABASE_URL = 'https://dqfithvufqewtchicrgw.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_wp6piNTxSLOXT-ezmfnhaQ_cFKP13k7';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Global State
        let activeParentKeys = { 1: null, 2: null, 3: null };
        let activeNames = { 1: null, 2: null, 3: null };
        let currentActiveItem = null;
        let currentActiveElement = null;
        let currentActiveColumn = null; 
        let isAdmin = false;
        let currentMobileCol = 1;

        // Init
        window.onload = async () => {
            await checkAdminAccess();
            renderColumn(1, null);
            updateMobileVisibility();
            window.addEventListener('resize', updateMobileVisibility);
        };

        // --- 2. AUTH & PERMISSIONS ---
        async function checkAdminAccess() {
            try {
                const sessionData = sessionStorage.getItem('sessionUser');
                if (!sessionData) return;
                
                // Parsing aman
                let user;
                try {
                    user = JSON.parse(sessionData);
                } catch (e) {
                    console.warn("Data sesi rusak, reset session.");
                    return;
                }

                if(user && user.username) {
                    const { data, error } = await _supabase.from('users').select('authority').eq('username', user.username).single();
                    if (data && !error) {
                        isAdmin = data.authority === 'Admin';
                    }
                }
            } catch (err) { 
                console.error("Akses Check Failed (Non-fatal)"); 
                isAdmin = false; 
            } finally {
                if (!isAdmin) {
                    document.querySelectorAll('.col-footer').forEach(f => f.style.display = 'none');
                }
            }
        }

        // --- 3. UI RENDER LOGIC ---
        function updateMobileVisibility() {
            if (window.innerWidth >= 768) {
                ['col1','col2','col3'].forEach(c => document.getElementById(`container-${c}`).classList.remove('mobile-hidden'));
            } else {
                for (let i = 1; i <= 3; i++) {
                    const el = document.getElementById(`container-col${i}`);
                    if (i === currentMobileCol) el.classList.remove('mobile-hidden');
                    else el.classList.add('mobile-hidden');
                }
            }
        }

        function navigateMobile(colNum) {
            currentMobileCol = colNum;
            updateMobileVisibility();
        }

        async function renderColumn(colNum, parentId) {
            const container = document.getElementById('col' + colNum);
            container.innerHTML = `<div class="p-8 text-center text-[10px] text-gray-400 font-bold animate-pulse tracking-widest uppercase">Memuat...</div>`;
            
            try {
                // Build Query
                const query = _supabase.from('tools1').select('*');
                if (parentId === null) query.is('parent_id', null);
                else query.eq('parent_id', parentId);

                const { data, error } = await query.order('name', { ascending: true });
                if (error) throw error;

                if (!data || data.length === 0) {
                    container.innerHTML = `<div class="mt-10 text-center opacity-20 text-[10px] font-bold uppercase tracking-widest text-gray-400 italic">Kosong</div>`;
                    return;
                }

                // Kalkulasi Badge Angka (Item Count)
                let itemStats = {};
                if (colNum === 1 || colNum === 2) {
                    const currentIds = data.map(item => item.id);
                    
                    if (colNum === 1) {
                        // Untuk kolom 1, kita hitung item di dalam subfolder
                        const { data: subFolders } = await _supabase.from('tools1').select('id, parent_id').in('parent_id', currentIds);
                        
                        if (subFolders && subFolders.length > 0) {
                            const subIds = subFolders.map(s => s.id);
                            const { data: files } = await _supabase.from('tools1').select('parent_id').in('parent_id', subIds);
                            
                            // Map subfolder ke parent utama
                            const subToFolderMap = {};
                            subFolders.forEach(s => subToFolderMap[s.id] = s.parent_id);
                            
                            // Init stats
                            data.forEach(item => itemStats[item.id] = { count: 0 });
                            
                            if (files) {
                                files.forEach(f => {
                                    const mainFolderId = subToFolderMap[f.parent_id];
                                    if (mainFolderId && itemStats[mainFolderId]) {
                                        itemStats[mainFolderId].count++;
                                    }
                                });
                            }
                        }
                    } else {
                        // Untuk kolom 2, kita hitung langsung anak-anaknya (file)
                        const { data: children } = await _supabase.from('tools1').select('id, parent_id').in('parent_id', currentIds);
                        if (children) {
                            children.forEach(child => {
                                if (!itemStats[child.parent_id]) itemStats[child.parent_id] = { count: 0 };
                                itemStats[child.parent_id].count++;
                            });
                        }
                    }
                }

                // Render HTML
                container.innerHTML = data.map((item, index) => {
                    const isFolder = item.type === 'folder';
                    const icon = isFolder 
                        ? `<svg class="w-4 h-4 mr-3 text-yellow-500 fill-current" viewBox="0 0 24 24"><path d="M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"></path></svg>`
                        : `<svg class="w-4 h-4 mr-3 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path></svg>`;
                    
                    const isSelected = activeParentKeys[colNum + 1] === item.id || (colNum === 3 && currentActiveItem === item.id) ? 'selected-item' : '';
                    
                    let infoTagsHtml = '';
                    if (colNum < 3) {
                        const stats = itemStats[item.id] || { count: 0 };
                        infoTagsHtml = `<span class="text-[9px] text-blue-500 font-bold mr-2 whitespace-nowrap bg-blue-50 px-1.5 py-0.5 rounded">${stats.count}</span>`;
                    } else if (item.type === 'file') {
                        const displayExt = item.extension ? item.extension : 'LINK';
                        infoTagsHtml = `<span class="text-[9px] text-indigo-500 font-bold opacity-80 uppercase px-1.5 py-0.5 bg-indigo-50 rounded w-10 text-center">${displayExt}</span>`;
                    }

                    const kebabButton = isAdmin ? `<button onclick="openMenu(event, '${item.id}', ${colNum})" class="menu-btn p-1 hover:bg-black/5 rounded-md ml-2 flex-shrink-0"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"></path></svg></button>` : '';
                    
                    const downloadButton = (colNum === 3 && item.type === 'file') 
                        ? `<button onclick="event.stopPropagation(); window.open('${item.file_url}', '_blank')" class="menu-btn p-1 hover:bg-blue-50 rounded-md ml-1 text-blue-600 flex-shrink-0" title="Buka / Download Link"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg></button>` 
                        : '';

                    return `
                        <div onclick="event.stopPropagation(); selectItem(${colNum}, this, '${item.id}', '${item.name}')" 
                             data-id="${item.id}" data-type="${item.type}" data-url="${item.file_url || ''}" 
                             data-drive-id="${item.drive_id || ''}"
                             class="column-entry bubble-item group ${isSelected}" style="animation-delay: ${index * 0.05}s">
                            ${icon}
                            <span class="flex-1 truncate font-semibold text-gray-700 mr-2">${item.name}</span>
                            <div class="flex items-center">
                                ${infoTagsHtml}
                                ${downloadButton}
                                ${kebabButton}
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (err) { 
                container.innerHTML = `<div class="p-4 text-xs text-red-500">Error: ${err.message}</div>`; 
            }
        }

        // --- 4. INTERACTION & SELECTION ---
        function selectItem(col, el, id, name) {
            // Prevent selection if renaming
            if (el.querySelector('.rename-input')) return;

            // Visual update
            el.parentElement.querySelectorAll('.column-entry').forEach(item => item.classList.remove('selected-item'));
            el.classList.add('selected-item');
            
            // State update
            activeNames[col] = name;
            currentActiveItem = id;
            currentActiveElement = el;
            currentActiveColumn = col;

            // Logic Cascade
            if (col === 1) {
                activeParentKeys[2] = id;
                activeNames[2] = null; activeNames[3] = null;
                if (isAdmin) document.getElementById('btnAddCol2').disabled = false;
                renderColumn(2, id);
                document.getElementById('col3').innerHTML = ''; // Clear col 3
                document.getElementById('btnAddCol3').disabled = true;
                if (window.innerWidth < 768) navigateMobile(2);
            } else if (col === 2) {
                activeParentKeys[3] = id;
                activeNames[3] = null;
                if (isAdmin) document.getElementById('btnAddCol3').disabled = false;
                renderColumn(3, id);
                if (window.innerWidth < 768) navigateMobile(3);
            } else if (col === 3) {
                const url = el.getAttribute('data-url');
                if (url) openPreviewModal(url, name);
            }
            updateBreadcrumb();
        }

        function deselectItem(colNum) {
            const container = document.getElementById('col' + colNum);
            if (container) container.querySelectorAll('.column-entry').forEach(el => el.classList.remove('selected-item'));
            activeNames[colNum] = null;
            
            if (colNum === 1) {
                activeParentKeys[2] = null; activeNames[2] = null; activeNames[3] = null;
                if (isAdmin) document.getElementById('btnAddCol2').disabled = true;
                document.getElementById('col2').innerHTML = ''; 
                document.getElementById('col3').innerHTML = '';
                if (isAdmin) document.getElementById('btnAddCol3').disabled = true;
            } else if (colNum === 2) {
                activeParentKeys[3] = null; activeNames[3] = null;
                if (isAdmin) document.getElementById('btnAddCol3').disabled = true;
                document.getElementById('col3').innerHTML = '';
            } else if (colNum === 3) {
                currentActiveItem = null;
            }
            updateBreadcrumb();
        }

        function updateBreadcrumb() {
            const container = document.getElementById('dynamicPath');
            container.innerHTML = [1, 2, 3].filter(c => activeNames[c]).map(c => `<span class="breadcrumb-separator">/</span><span class="text-gray-900 font-bold">${activeNames[c]}</span>`).join('');
        }

        async function addItem(colNum) {
            if (!isAdmin) return;
            if (colNum === 3) openAddModal();
            else if (colNum === 2) openSubfolderModal();
            else if (colNum === 1) openFolderModal();
        }

        // --- 5. MANAGEMENT: FOLDER (COL 1) ---
        function addFolderRow(name = '') {
            const body = document.getElementById('folderBody');
            const rowCount = body.children.length + 1;
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="ss-no">${rowCount}</td>
                <td><input type="text" placeholder="Nama Folder..." class="ss-input folder-name" value="${name}"></td>
                <td><button onclick="this.closest('tr').remove(); reindexFolderRows();" class="btn-ss-del"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg></button></td>
            `;
            tr.querySelector('.folder-name').addEventListener('paste', (e) => handleCommonPaste(e, addFolderRow));
            body.appendChild(tr);
        }

        function reindexFolderRows() { document.querySelectorAll('#folderBody .ss-no').forEach((el, i) => el.innerText = i + 1); }

        async function openFolderModal() {
            document.getElementById('folderBody').innerHTML = '';
            document.getElementById('folderProgressContainer').classList.remove('hidden'); 
            document.getElementById('folderModalOverlay').style.display = 'flex'; 
            setTimeout(() => document.getElementById('folderModalCard').classList.add('show'), 10);
            
            try {
                const { data } = await _supabase.from('tools1').select('name').is('parent_id', null).eq('type', 'folder').order('name', { ascending: true });
                if (data && data.length > 0) data.forEach(item => addFolderRow(item.name));
                else for(let i=0; i<3; i++) addFolderRow();
            } catch (err) { for(let i=0; i<3; i++) addFolderRow(); }
            finally { document.getElementById('folderProgressContainer').classList.add('hidden'); }
        }

        async function handleFolderBulkUpload() {
            if (!isAdmin) return;
            const rows = document.querySelectorAll('#folderBody tr');
            const payload = Array.from(rows).map(row => {
                const name = row.querySelector('.folder-name').value.trim();
                return name ? { name: name, type: 'folder', parent_id: null } : null;
            }).filter(Boolean);

            document.getElementById('folderProgressContainer').classList.remove('hidden');
            document.getElementById('btnExecuteFolder').disabled = true;
            
            try {
                // Delete existing root folders
                await _supabase.from('tools1').delete().is('parent_id', null).eq('type', 'folder');
                // Insert new
                if (payload.length > 0) await _supabase.from('tools1').insert(payload);
                closeFolderModal();
                await renderColumn(1, null);
            } catch (err) { alert("Gagal: " + err.message); }
            finally { 
                document.getElementById('btnExecuteFolder').disabled = false; 
                document.getElementById('folderProgressContainer').classList.add('hidden');
            }
        }
        function closeFolderModal() { 
            document.getElementById('folderModalCard').classList.remove('show'); 
            setTimeout(() => document.getElementById('folderModalOverlay').style.display = 'none', 200); 
        }

        // --- 6. MANAGEMENT: SUBFOLDER (COL 2) ---
        function addSubfolderRow(name = '') {
            const body = document.getElementById('subfolderBody');
            const rowCount = body.children.length + 1;
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="ss-no">${rowCount}</td>
                <td><input type="text" placeholder="Nama Subfolder..." class="ss-input sub-name" value="${name}"></td>
                <td><button onclick="this.closest('tr').remove(); reindexSubfolderRows();" class="btn-ss-del"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg></button></td>
            `;
            tr.querySelector('.sub-name').addEventListener('paste', (e) => handleCommonPaste(e, addSubfolderRow));
            body.appendChild(tr);
        }
        function reindexSubfolderRows() { document.querySelectorAll('#subfolderBody .ss-no').forEach((el, i) => el.innerText = i + 1); }

        async function openSubfolderModal() {
            const folderId = activeParentKeys[2];
            if (!folderId) return;
            document.getElementById('subfolderBody').innerHTML = '';
            document.getElementById('subfolderProgressContainer').classList.remove('hidden'); 
            document.getElementById('subfolderModalOverlay').style.display = 'flex'; 
            setTimeout(() => document.getElementById('subfolderModalCard').classList.add('show'), 10);
            try {
                const { data } = await _supabase.from('tools1').select('name').eq('parent_id', folderId).eq('type', 'folder').order('name', { ascending: true });
                if (data && data.length > 0) data.forEach(item => addSubfolderRow(item.name));
                else for(let i=0; i<3; i++) addSubfolderRow();
            } catch (err) { for(let i=0; i<3; i++) addSubfolderRow(); }
            finally { document.getElementById('subfolderProgressContainer').classList.add('hidden'); }
        }

        async function handleSubfolderBulkUpload() {
            if (!isAdmin) return;
            const parentId = activeParentKeys[2];
            if (!parentId) { alert("Parent ID hilang"); return; }

            const rows = document.querySelectorAll('#subfolderBody tr');
            const payload = Array.from(rows).map(row => {
                const name = row.querySelector('.sub-name').value.trim();
                return name ? { name: name, type: 'folder', parent_id: parentId } : null;
            }).filter(Boolean);

            document.getElementById('subfolderProgressContainer').classList.remove('hidden');
            document.getElementById('btnExecuteSubfolder').disabled = true;
            try {
                await _supabase.from('tools1').delete().eq('parent_id', parentId).eq('type', 'folder');
                if (payload.length > 0) await _supabase.from('tools1').insert(payload);
                closeSubfolderModal();
                await renderColumn(2, parentId);
                await renderColumn(1, null); // Refresh col 1 for badges
            } catch (err) { alert("Gagal: " + err.message); }
            finally { 
                document.getElementById('btnExecuteSubfolder').disabled = false; 
                document.getElementById('subfolderProgressContainer').classList.add('hidden');
            }
        }
        function closeSubfolderModal() { 
            document.getElementById('subfolderModalCard').classList.remove('show'); 
            setTimeout(() => document.getElementById('subfolderModalOverlay').style.display = 'none', 200); 
        }

        // --- 7. MANAGEMENT: FILES (COL 3) ---
        function addRow(name = '', url = '') {
            const body = document.getElementById('spreadsheetBody');
            const rowCount = body.children.length + 1;
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="ss-no">${rowCount}</td>
                <td><input type="text" placeholder="Nama File..." class="ss-input ss-name" value="${name}"></td>
                <td><input type="text" placeholder="URL Google Drive..." class="ss-input ss-url" value="${url}"></td>
                <td><button onclick="this.closest('tr').remove(); reindexRows();" class="btn-ss-del"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg></button></td>
            `;
            const inputs = tr.querySelectorAll('.ss-input');
            inputs.forEach(input => input.addEventListener('paste', handleSpreadsheetPaste));
            body.appendChild(tr);
        }
        function reindexRows() { document.querySelectorAll('#spreadsheetBody .ss-no').forEach((el, i) => el.innerText = i + 1); }

        // Paste Handler Logic (Generic for Folders)
        function handleCommonPaste(e, addRowFunc) {
            const clipboardData = e.clipboardData || window.clipboardData;
            const pastedText = clipboardData.getData('text');
            if (!pastedText.includes('\n')) return;
            
            e.preventDefault();
            const rowsData = pastedText.split(/\r?\n/).filter(r => r.trim()); // Remove empty lines
            
            const input = e.target;
            const tr = input.closest('tr');
            const tbody = tr.parentElement;
            const currentRows = Array.from(tbody.children); // Get initial rows
            const startIndex = currentRows.indexOf(tr);
            
            // 1. Process First Item (Insert at Cursor)
            if (rowsData.length > 0) {
                const firstText = rowsData[0];
                const start = input.selectionStart;
                const end = input.selectionEnd;
                // Insert text at cursor position
                input.value = input.value.substring(0, start) + firstText + input.value.substring(end);
            }

            // 2. Process Remaining Items
            for (let i = 1; i < rowsData.length; i++) {
                const text = rowsData[i];
                const targetIndex = startIndex + i;
                
                if (targetIndex < currentRows.length) {
                    // Overwrite existing row
                    const targetRow = currentRows[targetIndex];
                    const targetInput = targetRow.querySelector('input');
                    if (targetInput) targetInput.value = text;
                } else {
                    // Append new row
                    addRowFunc(text);
                }
            }
            
            if (addRowFunc === addFolderRow) reindexFolderRows();
            else reindexSubfolderRows();
        }

        // Paste Handler Logic (Complex for Files - columns support)
        function handleSpreadsheetPaste(e) {
            const clipboardData = e.clipboardData || window.clipboardData;
            const pastedText = clipboardData.getData('text');
            if (!pastedText.includes('\t') && !pastedText.includes('\n')) return;
            
            e.preventDefault();
            const rowsData = pastedText.split(/\r?\n/).filter(r => r.trim());
            
            const input = e.target;
            const startRowElement = input.closest('tr');
            const body = document.getElementById('spreadsheetBody');
            const initialRows = Array.from(body.querySelectorAll('tr'));
            const startRowIndex = initialRows.indexOf(startRowElement);
            
            const isNameCol = input.classList.contains('ss-name');
            const isUrlCol = input.classList.contains('ss-url');

            rowsData.forEach((rowStr, indexOffset) => {
                const columns = rowStr.split('\t');
                const targetRowIndex = startRowIndex + indexOffset;
                
                if (targetRowIndex < initialRows.length) {
                    // Modify existing row
                    const targetTr = initialRows[targetRowIndex];
                    const nameInput = targetTr.querySelector('.ss-name');
                    const urlInput = targetTr.querySelector('.ss-url');
                    
                    if (indexOffset === 0) {
                        // First Row: Insert at Cursor
                        const firstVal = columns[0] || '';
                        const start = input.selectionStart;
                        const end = input.selectionEnd;
                        input.value = input.value.substring(0, start) + firstVal + input.value.substring(end);
                        
                        // Handle second column if exists (overwrite)
                        if (isNameCol && columns[1] !== undefined) {
                            urlInput.value = columns[1].trim();
                        }
                    } else {
                        // Subsequent Rows: Overwrite
                        if (isNameCol) {
                            if (columns[0] !== undefined) nameInput.value = columns[0].trim();
                            if (columns[1] !== undefined) urlInput.value = columns[1].trim();
                        } else if (isUrlCol) {
                            if (columns[0] !== undefined) urlInput.value = columns[0].trim();
                        }
                    }
                } else {
                    // Create New Row (Append)
                    if (isNameCol) {
                        addRow(columns[0] || '', columns[1] || '');
                    } else if (isUrlCol) {
                        addRow('', columns[0] || '');
                    }
                }
            });
            reindexRows();
        }

        async function openAddModal() { 
            const folderId = activeParentKeys[3];
            document.getElementById('spreadsheetBody').innerHTML = '';
            document.getElementById('uploadProgressContainer').classList.remove('hidden');
            document.getElementById('addModalOverlay').style.display = 'flex'; 
            setTimeout(() => document.getElementById('addModalCard').classList.add('show'), 10);
            try {
                const { data } = await _supabase.from('tools1').select('name, file_url').eq('parent_id', folderId).eq('type', 'file').order('name', { ascending: true });
                if (data && data.length > 0) data.forEach(item => addRow(item.name, item.file_url));
                else for(let i=0; i<3; i++) addRow();
            } catch (err) { for(let i=0; i<3; i++) addRow(); }
            finally { document.getElementById('uploadProgressContainer').classList.add('hidden'); }
        }
        function closeAddModal() { 
            document.getElementById('addModalCard').classList.remove('show'); 
            setTimeout(() => document.getElementById('addModalOverlay').style.display = 'none', 200); 
        }

        async function handleSpreadsheetUpload() {
            if (!isAdmin) return;
            const folderId = activeParentKeys[3];
            const rows = document.querySelectorAll('#spreadsheetBody tr');
            const payload = Array.from(rows).map(row => {
                const name = row.querySelector('.ss-name').value.trim();
                const url = row.querySelector('.ss-url').value.trim();
                if (name && url) {
                    let driveId = null;
                    const idMatch = url.match(/[-\w]{25,}/);
                    if (idMatch) driveId = idMatch[0];
                    let ext = name.includes('.') ? name.split('.').pop().toUpperCase() : 'LINK';
                    return { name: name, type: 'file', parent_id: folderId, file_url: url, drive_id: driveId, extension: ext };
                }
                return null;
            }).filter(Boolean);

            document.getElementById('uploadProgressContainer').classList.remove('hidden');
            document.getElementById('btnExecuteUpload').disabled = true;
            try {
                await _supabase.from('tools1').delete().eq('parent_id', folderId).eq('type', 'file');
                if (payload.length > 0) await _supabase.from('tools1').insert(payload);
                closeAddModal();
                await renderColumn(3, folderId);
                await renderColumn(2, activeParentKeys[2]); // Update counts
            } catch (err) { alert("Gagal: " + err.message); }
            finally { 
                document.getElementById('btnExecuteUpload').disabled = false; 
                document.getElementById('uploadProgressContainer').classList.add('hidden');
            }
        }

        // --- 8. PREVIEW & ACTIONS ---
        function openPreviewModal(url, name) {
            const frame = document.getElementById('previewFrame');
            const title = document.getElementById('previewTitle');
            const loader = document.getElementById('previewLoader');
            
            title.innerText = name;
            let driveId = '';
            const idMatch = url.match(/[-\w]{25,}/);
            if (idMatch) driveId = idMatch[0];
            
            loader.classList.remove('hidden');
            frame.src = driveId ? `https://drive.google.com/file/d/${driveId}/preview` : url;
            frame.classList.remove('hidden');
            
            document.getElementById('previewModalOverlay').style.display = 'flex';
            setTimeout(() => { 
                document.getElementById('previewModalCard').classList.add('show'); 
                setTimeout(() => loader.classList.add('hidden'), 3000); 
            }, 10);
        }

        function closePreviewModal() {
            document.getElementById('previewModalCard').classList.remove('show');
            setTimeout(() => { 
                document.getElementById('previewModalOverlay').style.display = 'none'; 
                document.getElementById('previewFrame').src = ''; 
            }, 200);
        }

        function openMenu(e, itemId, colNum) {
            e.stopPropagation();
            currentActiveItem = itemId; 
            currentActiveElement = e.currentTarget.closest('.column-entry'); 
            currentActiveColumn = colNum;
            
            const rect = e.currentTarget.getBoundingClientRect();
            const menu = document.getElementById('contextMenu');
            
            // Show/Hide "Buka Link" if it's a file
            document.getElementById('menuDownload').classList.toggle('hidden', currentActiveElement.getAttribute('data-type') !== 'file');
            
            menu.style.display = 'block'; 
            menu.style.top = `${rect.bottom + 5}px`; 
            
            // Adjust left to not go off screen
            const leftPos = rect.left - 120;
            menu.style.left = `${leftPos < 0 ? 10 : leftPos}px`;
        }

        function closeMenu() { document.getElementById('contextMenu').style.display = 'none'; }

        async function handleAction(action) {
            if (!isAdmin) return;
            if (action === 'rename') {
                const textSpan = currentActiveElement.querySelector('span');
                const oldName = textSpan.innerText;
                textSpan.classList.add('hidden');
                
                const input = document.createElement('input');
                input.className = 'rename-input'; 
                input.value = oldName;
                
                textSpan.parentNode.insertBefore(input, textSpan);
                input.focus(); 
                input.select();
                
                input.onblur = async () => {
                    const newName = input.value.trim();
                    if (newName && newName !== oldName) {
                        await _supabase.from('tools1').update({ name: newName }).eq('id', currentActiveItem);
                        textSpan.innerText = newName;
                        activeNames[currentActiveColumn] = newName;
                        updateBreadcrumb();
                    }
                    input.remove(); 
                    textSpan.classList.remove('hidden');
                };
                
                input.onkeydown = (e) => { if(e.key==='Enter') input.blur(); };
            
            } else if (action === 'delete') {
                openDeleteModal();
            } else if (action === 'download') {
                window.open(currentActiveElement.getAttribute('data-url'), '_blank');
            }
            closeMenu();
        }

        function openDeleteModal() { document.getElementById('deleteModalOverlay').style.display = 'flex'; setTimeout(() => document.getElementById('deleteModalCard').classList.add('show'), 10); }
        function closeDeleteModal() { document.getElementById('deleteModalCard').classList.remove('show'); setTimeout(() => document.getElementById('deleteModalOverlay').style.display = 'none', 200); }

        async function executeDeletion() {
            if (!isAdmin || !currentActiveItem) return;
            const col = currentActiveColumn;
            const btn = document.getElementById('btnConfirmDelete');
            btn.innerText = "Menghapus..."; btn.disabled = true;

            try {
                const isFolder = currentActiveElement.getAttribute('data-type') === 'folder';

                // Cascade Delete Logic (Safe)
                if (isFolder) {
                    if (col === 1) {
                        // Delete sub-files first, then sub-folders, then main folder
                        const { data: subs } = await _supabase.from('tools1').select('id').eq('parent_id', currentActiveItem);
                        if (subs?.length > 0) {
                            const subIds = subs.map(s => s.id);
                            // Delete items inside subfolders
                            await _supabase.from('tools1').delete().in('parent_id', subIds); 
                            // Delete subfolders
                            await _supabase.from('tools1').delete().in('id', subIds); 
                        }
                    } else if (col === 2) {
                        // Delete files inside this folder
                        await _supabase.from('tools1').delete().eq('parent_id', currentActiveItem); 
                    }
                }

                // Delete the item itself
                await _supabase.from('tools1').delete().eq('id', currentActiveItem);
                
                closeDeleteModal();
                
                // Refresh Columns
                await renderColumn(col, activeParentKeys[col]);
                if (col >= 2) renderColumn(1, null); // Refresh badges
                
            } catch (err) { 
                alert("Gagal menghapus: " + err.message); 
            } finally {
                btn.innerText = "Hapus"; btn.disabled = false;
            }
        }
    </script>
</body>
</html>